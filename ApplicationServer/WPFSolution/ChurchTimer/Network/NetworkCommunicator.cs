namespace TheLiveTimer.Server.Network
{
    using System;
    using System.Collections.Concurrent;
    using System.Threading;
    using TheLiveTimer.Network;

    internal class NetworkCommunicator
    {
        private readonly ITransmitterAsync transmitter;
        private readonly IReceiver receiver;
        private readonly BlockingCollection<ReceivedPacket> clientResponseQueue;

        private readonly ClientManager clientManager;
        private Thread clientAcceptanceThread;

        public NetworkCommunicator(int receivePort, int sendPort)
        {
            var serverIP = NetworkUtils.GetLocalIPv4(System.Net.NetworkInformation.NetworkInterfaceType.Ethernet);
            this.ServerAddress = new NetworkAddress(serverIP, receivePort);
            this.clientResponseQueue = new BlockingCollection<ReceivedPacket>(boundedCapacity: ClientManager.MaxClients + 1);

            this.transmitter = new Transmitter(sendPort);
            this.receiver = new TcpReceiver(receivePort, this.clientResponseQueue);
            this.clientManager = new ClientManager(this);

            this.InitialiseCommunicator();
        }

        public int TotalClients { get { return this.clientManager.TotalClients; }}

        public long CommunicationId { get { return CommandDataFactory.Instance.CommunicationId; }}

        /// <summary>
        /// Gets the <see cref="NetworkAddress"/> of the server
        /// </summary>
        /// <value>The server address.</value>
        public NetworkAddress ServerAddress { get; }

        public void AcceptClients()
        {
            Console.WriteLine("Accepting clients");

            // Send out ServerReady message
            var data = new ServerMessageData(ServerMessage.ServerReady, this.ServerAddress);
            this.TransmitData(data);
        }

        public void BroadcastCommand(TimerCommand command, params double[] args)
        {
            if (args != null)
            {
                byte[] result = new byte[args.Length * sizeof(double)];
                Buffer.BlockCopy(args, 0, result, 0, result.Length);
                this.BroadcastCommand(command, result);
            }
            else
            {
                this.BroadcastCommand(command, new byte[0]);
            }
        }

        public void BroadcastCommand(TimerCommand command, byte[] args)
        {
            Console.WriteLine("Broadcasting command: " + command.ToString());
            var commandData = CommandDataFactory.Instance.GetCommandData(command, args);
            this.TransmitData(commandData);
        }

        public void TransmitData(NetworkData data)
        {
            var packet = NetworkPacketFactory.Instance.GetNetworkPacket(data);
            var bytes = NetworkUtils.ObjectToByteArray(packet);
            this.transmitter.BroadcastAsync(bytes);
        }

        private void InitialiseCommunicator()
        {
            if (!this.receiver.IsListening)
            {
                this.receiver.StartListening();
            }

            if(this.clientAcceptanceThread == null)
            {
                this.clientAcceptanceThread = new Thread(() =>
                {
                    this.ConsumeClient(this.clientResponseQueue);
                });

                this.clientAcceptanceThread.Start();                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
            }

            CommandDataFactory.Instance.NextCommunicationId();
        }

        private void ConsumeClient(BlockingCollection<ReceivedPacket> queue)
        {
            while (true)
            {
                var packet = queue.Take();
                this.clientManager.HandleClientPacket(packet);
            }
        }
    }
}

